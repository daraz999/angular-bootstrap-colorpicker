angular.module("colorpicker.module",[]).factory("Helper",function(){"use strict";return{closestSlider:function(e){var o=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;return o.bind(e)("I")?e.parentNode:e},getOffset:function(e,o){for(var t=0,n=0,r=e.getBoundingClientRect();e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)o||"BODY"!==e.tagName?(t+=e.scrollLeft,n+=e.scrollTop):(t+=document.documentElement.scrollLeft||e.scrollLeft,n+=document.documentElement.scrollTop||e.scrollTop),e=e.offsetParent;return{top:r.top+window.pageYOffset,left:r.left+window.pageXOffset,scrollX:t,scrollY:n}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(e){"use strict";return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,o,t,n){e/=255,o/=255,t/=255;var r,c,l,i;return l=Math.max(e,o,t),i=l-Math.min(e,o,t),r=0===i?null:l===e?(o-t)/i:l===o?(t-e)/i+2:(e-o)/i+4,r=(r+360)%6*60/360,c=0===i?0:i/l,{h:r||1,s:c,b:l,a:n||1}},setColor:function(o){o=o?o.toLowerCase():o;for(var t in e.stringParsers)if(e.stringParsers.hasOwnProperty(t)){var n=e.stringParsers[t],r=n.re.exec(o),c=r&&n.parse(r);if(c)return this.value=this.RGBtoHSB.apply(null,c),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,o,t,n){e||(e=this.value.h,o=this.value.s,t=this.value.b),e*=360;var r,c,l,i,s;return e=e%360/60,s=t*o,i=s*(1-Math.abs(e%2-1)),r=c=l=t-s,e=~~e,r+=[s,i,0,0,i,s][e],c+=[i,s,s,i,0,0][e],l+=[0,0,i,s,s,i][e],{r:Math.round(255*r),g:Math.round(255*c),b:Math.round(255*l),a:n||this.value.a}},toHex:function(e,o,t,n){var r=this.toRGB(e,o,t,n);return"#"+(1<<24|parseInt(r.r,10)<<16|parseInt(r.g,10)<<8|parseInt(r.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(e){"use strict";var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},t={};return{getSlider:function(){return o},getLeftPosition:function(e){return Math.max(0,Math.min(o.maxLeft,o.left+((e.pageX||t.left)-t.left)))},getTopPosition:function(e){return Math.max(0,Math.min(o.maxTop,o.top+((e.pageY||t.top)-t.top)))},setSlider:function(n,r){var c=e.closestSlider(n.target),l=e.getOffset(c,r),i=c.getBoundingClientRect(),s=n.clientX-i.left,a=n.clientY-i.top;o.knob=c.children[0].style,o.left=n.pageX-l.left-window.pageXOffset+l.scrollX,o.top=n.pageY-l.top-window.pageYOffset+l.scrollY,t={left:n.pageX-(s-o.left),top:n.pageY-(a-o.top)}},setSaturation:function(e,t){o={maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e,t)},setHue:function(e,t){o={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"},this.setSlider(e,t)},setAlpha:function(e,t){o={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"},this.setSlider(e,t)},setKnob:function(e,t){o.knob.top=e+"px",o.knob.left=t+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(e,o,t,n,r){"use strict";return{require:"?ngModel",restrict:"A",link:function(c,l,i,s){function a(){e.on("mousemove",p),e.on("mouseup",u)}function f(){try{D.css("backgroundColor",M[w]())}catch(e){D.css("backgroundColor",M.toHex())}B.css("backgroundColor",M.toHex(M.value.h,1,1,1)),"rgba"===w&&(S.css.backgroundColor=M.toHex())}function p(e){var o=n.getLeftPosition(e),t=n.getTopPosition(e),r=n.getSlider();n.setKnob(t,o),r.callLeft&&M[r.callLeft].call(M,o/100),r.callTop&&M[r.callTop].call(M,t/100),f();var i=M[w]();return l.val(i),s&&c.$apply(s.$setViewValue(i)),O&&Y.val(i),!1}function u(){m("colorpicker-selected"),e.off("mousemove",p),e.off("mouseup",u)}function d(e){M.setColor(l.val()),O&&!e&&Y.val(l.val()),N.eq(0).css({left:100*M.value.s+"px",top:100-100*M.value.b+"px"}),N.eq(1).css("top",100*(1-M.value.h)+"px"),N.eq(2).css("top",100*(1-M.value.a)+"px"),f()}function g(){var e,o=r.getOffset(l[0]);return angular.isDefined(i.colorpickerParent)&&(o.left=0,o.top=0),"top"===y?e={top:o.top-147,left:o.left}:"right"===y?e={top:o.top,left:o.left+126}:"bottom"===y?e={top:o.top+l[0].offsetHeight+2,left:o.left}:"left"===y&&(e={top:o.top,left:o.left-150}),{top:e.top+"px",left:e.left+"px"}}function k(){b()}function h(){T.hasClass("colorpicker-visible")||(d(),T.addClass("colorpicker-visible").css(g()),m("colorpicker-shown"),C===!1&&e.on("mousedown",k),i.colorpickerIsOpen&&(c[i.colorpickerIsOpen]=!0,c.$$phase||c.$digest())),v()}function v(){if("undefined"==typeof Storage)return!1;var e=localStorage.getItem("recentColors")||"[]";if(e=JSON.parse(e),!e.length)return!1;var o=T.find("colorpicker-recent").find("div").find("span");if(!o.length)return!1;for(var t=0;t<e.length;t++)angular.element(o[t]).css("background-color",e[t]);T.find("colorpicker-recent").css("display","block")}function m(e){s&&c.$emit(e,{name:i.ngModel,value:s.$modelValue})}function b(){T.hasClass("colorpicker-visible")&&(T.removeClass("colorpicker-visible"),m("colorpicker-closed"),e.off("mousedown",k),i.colorpickerIsOpen&&(c[i.colorpickerIsOpen]=!1,c.$$phase||c.$digest())),x()}function x(){if("undefined"==typeof Storage||!l.val())return!1;var e=M.toHex(),o=localStorage.getItem("recentColors")||"[]";return o=JSON.parse(o),-1!==o.indexOf(e)?!0:(o.unshift(e),o=o.slice(0,6),void localStorage.setItem("recentColors",JSON.stringify(o)))}var S,w=i.colorpicker?i.colorpicker:"hex",y=angular.isDefined(i.colorpickerPosition)?i.colorpickerPosition:"bottom",C=angular.isDefined(i.colorpickerInline)?i.colorpickerInline:!1,I=angular.isDefined(i.colorpickerFixedPosition)?i.colorpickerFixedPosition:!1,L=angular.isDefined(i.colorpickerParent)?l.parent():angular.element(document.body),O=angular.isDefined(i.colorpickerWithInput)?i.colorpickerWithInput:!1,H=O?'<input type="text" name="colorpicker-input" spellcheck="false">':"",$=C?"":'<button type="button" class="close close-colorpicker">&times;</button>',P='<div class="colorpicker dropdown"><div class="dropdown-menu"><colorpicker-recent><span>Recent colors:</span><div><span style="background-color: #ffffff;" class="recent recent-1"></span><span style="background-color: #ffffff;" class="recent recent-2"></span><span style="background-color: #ffffff;" class="recent recent-3"></span><span style="background-color: #ffffff;" class="recent recent-4"></span><span style="background-color: #ffffff;" class="recent recent-5"></span><span style="background-color: #ffffff;" class="recent recent-6"></span></div></colorpicker-recent><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+H+$+"</div></div>",T=angular.element(P),M=t,A=T.find("colorpicker-hue"),B=T.find("colorpicker-saturation"),D=T.find("colorpicker-preview"),N=T.find("i"),R=T.find("colorpicker-recent").find("div").find("span");if(o(T)(c),O){var Y=T.find("input");Y.on("mousedown",function(e){e.stopPropagation()}).on("keyup",function(){var e=this.value;l.val(e),s&&s.$modelValue!==e&&(c.$apply(s.$setViewValue(e)),d(!0))})}"rgba"===w&&(T.addClass("alpha"),S=T.find("colorpicker-alpha"),S.on("click",function(e){n.setAlpha(e,I),p(e)}).on("mousedown",function(e){n.setAlpha(e,I),a()}).on("mouseup",function(e){m("colorpicker-selected-alpha")})),A.on("click",function(e){n.setHue(e,I),p(e)}).on("mousedown",function(e){n.setHue(e,I),a()}).on("mouseup",function(e){m("colorpicker-selected-hue")}),R.on("click",function(e){var o=angular.element(e.currentTarget).css("background-color");M.setColor(o),l.val(M.toHex()),d()}),B.on("click",function(e){n.setSaturation(e,I),p(e),angular.isDefined(i.colorpickerCloseOnSelect)&&b()}).on("mousedown",function(e){n.setSaturation(e,I),a()}).on("mouseup",function(e){m("colorpicker-selected-saturation")}),I&&T.addClass("colorpicker-fixed-position"),T.addClass("colorpicker-position-"+y),"true"===C&&T.addClass("colorpicker-inline"),L.append(T),s&&(s.$render=function(){l.val(s.$viewValue),d()}),l.on("blur keyup change",function(){d()}),l.on("$destroy",function(){T.remove()}),C===!1?l.on("click",h):h(),T.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()}),T.find("button").on("click",function(){b()}),i.colorpickerIsOpen&&c.$watch(i.colorpickerIsOpen,function(e){e===!0?h():e===!1&&b()})}}}]);